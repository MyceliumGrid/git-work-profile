name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Verify dependencies
        run: go mod verify

      - name: Build
        run: go build -v ./...

      - name: Run tests
        run: go test -v ./...
        env:
          SKIP_GIT_TESTS: "false"  # è®¾ç½®ä¸º true å¯ä»¥è·³è¿‡ä¾èµ– git å‘½ä»¤çš„æµ‹è¯•

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest

      - name: Verify prompt templates
        run: |
          echo "ğŸ“ Verifying prompt template files..."
          
          # Check if prompts directory exists
          if [ ! -d "prompts" ]; then
            echo "âŒ Error: prompts directory is missing"
            exit 1
          fi
          echo "âœ“ prompts directory exists"
          
          # Define required prompt files
          required_files=(
            "developer-profile.txt"
            "project-experience.txt"
            "techstack-analysis.txt"
          )
          
          # Check each file
          missing_files=()
          for file in "${required_files[@]}"; do
            if [ -f "prompts/$file" ]; then
              size=$(wc -c < "prompts/$file" | tr -d ' ')
              echo "  âœ“ $file (${size} bytes)"
            else
              missing_files+=("$file")
              echo "  âŒ $file (missing)"
            fi
          done
          
          # Report results
          if [ ${#missing_files[@]} -gt 0 ]; then
            echo ""
            echo "âŒ Error: Missing ${#missing_files[@]} prompt template file(s):"
            printf '  - %s\n' "${missing_files[@]}"
            exit 1
          fi
          
          echo ""
          echo "âœ… All ${#required_files[@]} prompt template files are present and valid"
